{% extends "base.html" %}

{% block title %}{{ event.title }} - Event Management Dashboard{% endblock %}

{% block content %}
<div class="event-view-container">
    <div class="event-header">
        <h1>{{ event.title }}</h1>
        {% if current_user.id == event.organizer_id %}
            <div class="event-header-actions">
                <a href="{{ url_for('events.edit_event', event_id=event.id) }}" class="btn btn-secondary">Edit</a>
                <form method="POST" action="{{ url_for('events.delete_event', event_id=event.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this event?');">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        {% endif %}
    </div>
    
    <div class="event-details-full">
        <div class="detail-item">
            <strong>Description:</strong>
            <p>{{ event.description }}</p>
        </div>
        
        <div class="detail-item">
            <strong>Date & Time:</strong>
            <p>{{ event.event_date.strftime('%Y-%m-%d %H:%M') }}</p>
        </div>
        
        <div class="detail-item">
            <strong>Location:</strong>
            <p>{{ event.location }}</p>
        </div>
        
        <div class="detail-item">
            <strong>Registration Deadline:</strong>
            <p>{{ event.registration_deadline.strftime('%Y-%m-%d %H:%M') }}</p>
        </div>
        
        <div class="detail-item">
            <strong>Registrations:</strong>
            <p>
                <span id="reg-count">{{ event.registration_count }}</span>
                {% if event.max_registrations %} / {{ event.max_registrations }}{% else %} (no limit){% endif %}
            </p>
        </div>
        
        <div class="detail-item">
            <strong>Organizer:</strong>
            <p>{{ event.organizer.username }}</p>
        </div>
        
        <div class="detail-item">
            <strong>Status:</strong>
            <p>
                {% if not event.is_registration_open %}
                    <span class="status-badge status-closed">Registration Closed</span>
                {% elif event.is_full %}
                    <span class="status-badge status-full">Event Full</span>
                {% else %}
                    <span class="status-badge status-open">Registration Open</span>
                {% endif %}
            </p>
        </div>
    </div>
    
    {% if current_user.id != event.organizer_id %}
        <div class="event-registration">
            {% if is_registered %}
                <p class="registered-message">You are registered for this event!</p>
                <form method="POST" action="{{ url_for('events.cancel_registration', event_id=event.id) }}">
                    <button type="submit" class="btn btn-danger">Cancel Registration</button>
                </form>
            {% elif event.is_full %}
                <p class="error-message">This event is full.</p>
            {% elif not event.is_registration_open %}
                <p class="error-message">Registration for this event is closed.</p>
            {% else %}
                <form method="POST" action="{{ url_for('events.register_event', event_id=event.id) }}">
                    <button type="submit" class="btn btn-primary btn-large">Register for Event</button>
                </form>
            {% endif %}
        </div>
    {% endif %}
    
    <div class="back-link">
        <a href="{{ url_for('events.list_events') }}" class="btn btn-secondary">Back to Events</a>
    </div>
</div>

<script>
    // Real-time update for registration count
    setInterval(() => {
        fetch('{{ url_for("events.get_registration_count", event_id=event.id) }}')
            .then(response => response.json())
            .then(data => {
                const countElement = document.getElementById('reg-count');
                if (countElement) {
                    countElement.textContent = data.count;
                }
            });
    }, 5000); // Update every 5 seconds
</script>
{% endblock %}

